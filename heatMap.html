<!DOCTYPE html>
<meta charset="utf-8">
<html>
	<head>
		<!-- Meta Tags -->
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		
		<!-- D3 -->
		<script src="https://d3js.org/d3.v4.min.js"></script>
		<script src="d3-tip.js"></script>
		
		<!-- Google Font (ROBOTO) -->
		<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
		
		<!-- Bootstrap -->
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">
		<script src="https://code.jquery.com/jquery-3.1.1.slim.min.js" integrity="sha384-A7FZj7v+d/sdmMqp/nOQwliLvUsJfDHW+k9Omg/a/EheAdgtzNs3hpfag6Ed950n" crossorigin="anonymous"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js" integrity="sha384-DztdAPBWPRXSA/3eYEEUWrWCy7G5KFbe8fFjk5JAIxUYHKkDx6Qin1DkWx51bBrb" crossorigin="anonymous"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js" integrity="sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn" crossorigin="anonymous"></script>
	  
	  	<!-- Customised CSS -->
		<link href="additionalstyles.css" rel="stylesheet">
	</head>
	
	<body>
		<div id="chart"></div>
		<div id="dataset-picker"> </div>
		<script>
			// Define the file directory
			var jsonFile = "../data/git-commit-frequency.json";
			
			// Create the division of the chart
			var margin = { top: 50, right: 100, bottom: 100, left: 30 },
				width = 960 - margin.left - margin.right,
				height = 280 - margin.top - margin.bottom,
				gridSize = Math.floor(width / 52),
				legendElementWidth = gridSize*2,
				buckets = 4,
				defaultColor = "#f0f7da",
				colors = ["#c9df8a","#77ab59","#36802d","#234d20"],
				daysOfTheWeek = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"],
				months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
			
			// Move the chart
			var svg = d3.select("#chart").append("svg")
				.attr("width", width + margin.left + margin.right)
				.attr("height", height + margin.top + margin.bottom)
				.append("g")
				.attr("transform", "translate(" + margin.left + "," + margin.top + ")");
			
			// Create the Heat Map using D3
			d3.json(jsonFile, function(error,data){
				// Refine and Clean data into a proper structure, {day, week, commits}
				var refineData = parseAndCleanData(data);
				
				// Computes the minimum and Maximum number of commits {return [min, max]}
				var minValue = d3.min(refineData, function(d){return d.commits;});
				var maxValue = d3.max(refineData, function(d){return d.commits;});
				var maxWeeks = d3.max(refineData, function(d){return d.week;});
				var minAndMaxArray = adjustMinMaxValues(minValue, maxValue);
				
				/**
				 * Define the colour range into equal parts between the min and max value
				 * Example if domain(10,100) and range([1,2,3])
				 * width 10 to 40 will be 1
				 * width 40 to 70 will be 2
				 * width 70 to 100 will be 3
				 */
				var colorScale = d3.scaleQuantile()
									.domain(minAndMaxArray)
									.range(colors);
				
				// Day Label Settings
				var dayLabels = svg.selectAll(".dayLabel")
					.data(daysOfTheWeek)
					.enter().append("text")
					.text(function (d) { return d; })
					.attr("x", 0)
					.attr("y", function (d, i) { return i * gridSize; })
					.style("text-anchor", "end")
					.attr("transform", "translate(-6," + gridSize / 1.5 + ")")
					.attr("class", "dayLabel mono axis axis-workweek");
								
				// Week Label Settings
				var weekLabels = svg.selectAll(".weekLabel")
					.data(data)
					.enter().append("text")
					.text(function(d,i) {
						var date = new Date(+d.week*1000);
						// Check to see if it is the first week of the month
						// Check to see if it is the last week
						if((date.getDate() < 8 || i == 0) && i != maxWeeks-1)
							return months[date.getMonth()];
						else
							return "";
					})
					.attr("x", function(d, i) { return i * gridSize; })
					.attr("y", 0)
					.attr("transform", function(d){return "rotate(-90)";})
					.style("text-anchor", "start")
					.attr("transform", "translate(" + gridSize / 2 + ", -6)")
					.attr("class", "timeLabel mono axis axis-worktime");
				

				
				// Bind data
				var blocks = svg.selectAll("rect").data(refineData);
				
				// Enter the blocks
				blocks.enter().append("rect")
					.attr("x", function(d) { return (d.week-1) * gridSize; })
					.attr("y", function(d) { return (d.day-1) * gridSize; })
					.attr("rx", 2)
					.attr("ry", 2)
					.attr("width", gridSize*0.9)
					.attr("height", gridSize*0.9)
					.style("fill", defaultColor)
					.on("mouseover", function(d){					
						var xPosition = d3.select(this).attr("x");
						var yPosition = d3.select(this).attr("y");
						tooltip
							.style("left", xPosition - 53 + "px")
              				.style("top", yPosition - (-15) + "px")
              				.style("display", "inline")
              				.html(d.commits + " contributions on Feb 19, 2017");
						d3.select(this).attr("class", "selected"); //Change the border of the cude
						//tooltip.style("display", null);
						//d3.select(this).attr("class", "noBorder");
					})
					.on("mouseout", function() {
						tooltip.style("display", "none");
						d3.select(this).attr("class", "noBorder");
					})
					.on("mousemove", function(d){
						/*tooltip
						    //.style("right", d3.event.pageX + "px")
							.style("left", d3.event.pageX - 90 + "px")
              				.style("top", d3.event.pageY - 40 +"px")
              				.style("display", "inline-block")
              				.html(d.commits + " contributions on Feb 19, 2017");
						d3.select(this).attr("class", "selected"); //Change the border of the cude*/
					})
				
				// Update
				.merge(blocks).transition().duration(1000)
              		.style("fill", function(d) { 
						if(d.commits == 0)
							return defaultColor;
						else
							return colorScale(d.commits);
					});
				
				
				
				// Tooltip
				var tooltip = d3.select("body").append("div").attr("class", "d3-tip");
				
				// Tootltip text
				//tooltip.append("text");
				

				
				// Exit method to remove unused elements
				blocks.exit().remove();
				
				
				// Bind Data
				var legend = svg.selectAll(".legend")
					.data([0,1].concat(colorScale.quantiles())); //Array with 1, concatenated with the colour quantiles
				
				// Group the data
				var legend_g = legend.enter().append("g").attr("class", "legend");
				
				// Append the rectangle to the group
				legend_g.append("rect")
					.attr("x", function(d, i) { return legendElementWidth * i; })
					.attr("y", height)
					.attr("width", legendElementWidth)
					.attr("height", gridSize/2)
					.style("fill", function(d,i) { 
						if(i == 0)
							return defaultColor;
						else
							return colors[i-1];
					});
				
				// Append text
				legend_g.append("text")
					.attr("class", "mono")
					.text(function(d) { 
						var arr = colorScale.quantiles();
						var steps = arr[1] - arr[0] - 1;
						if(d == 0)
							return Math.round(d);
						else
							return Math.round(d) + " - " + (Math.round(d)+steps);
					})
					.attr("x", function(d, i) { return legendElementWidth * (i+0.5); })
					.attr("y", height + gridSize*1.2)
					.style("text-anchor", "middle");
				
				// Exit Method to remove used elements
				legend.exit().remove();
			});
			
			/**
			 * Parse and Clean the JSON file into a new data structure
			 * Each Object will consist of the following field:
			 * 1) [day] Day of the Week (1 to 7)
			 * 2) [week] Week of the Year (1 to 52)
			 * 3) [commits] Number of git commits made on the day
			 * 4) [Date] The date stamp associated with the week
			 */
			function parseAndCleanData(d){
				var arr = [];
				for(var j = 0; j < d[0].days.length; j++){
					for(var i = 0; i < d.length; i++){
						var data = new Object()
						data.day = j+1;
						data.week = i+1;
						data.commits = +d[i].days[j];
						arr.push(data);
					}
				}
				return arr;
			}
			
			/**
			 * Function to adjust the Min and Max value so that in increases linearly
			 * 0 will be given a default colour
			 * Subsequent intervals will be increasing on a linear scale
			 * Precondition: maxValue is already adjusted to remove any anomalys
			 * Postcondition: return an array which increases linearly
			 */
			function adjustMinMaxValues(minValue, maxValue){
				// Add 1 to accomodate the default colour of 0
				var newMin = minValue + 1;
				var newMax = maxValue + 1;
				
				// Adjust the min and max so that the scale is linear
				if((newMax-newMin) % buckets != 0){
					newMax += buckets - ((newMax-newMin) % buckets);
				}
				
				// Return the newMin and newMax
				return [newMin, newMax];
			}
    	</script>
	</body>
</html>